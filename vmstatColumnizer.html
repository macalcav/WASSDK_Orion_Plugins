<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Vmstat Columnizer</title>
<script type="text/javascript" src="plugin.js"></script>
<script type="text/javascript" src="require.js"></script>
<script type="text/javascript" src="columnify"></script>
<script>
/*eslint-env browser, amd*/
/*global orion*/	

//********************
//********************
//INSTRUCTIONS:
//select a vmstat file -> Tools ->Vmstat Columnizer
//********************
//********************


window.onload = function() {
	
	var headers = { name: "Vmstat Columnizer", version: "1.0", description: "TOOLS -> Vmstat Columnizer -- places vmstat data into columns for readability macalcav@us.ibm.com - WASSDK" };
	var provider = new orion.PluginProvider(headers);		
	var serviceImpl = {
	    run: function(selectedText, text, selection) {
	    	  	return {
	    	  		     text: vmstatColumnize(text),
	    	  		selection:{start:0, end:0}
	    	  	};
		}
	};
	
	function vmstatColumnize(text){
		var columnify = require('columnify');
		return columnify(makeVmstatKeyValuePairs(text),{align: 'right'});
	}
	
	function makeVmstatKeyValuePairs (textToColumnize) {
		var lines = textToColumnize.split("\n");
		var numLines = lines.length;
		var key;
		var keyValuePairs= [];
		for (var i = 0; i < numLines; i++) {
			lines[i]=lines[i].replace(/^\s+|\s+$/gm,'');//remove white space from both ends
			lines[i]=lines[i].replace(/\s\s+/g, ' ');//remove multiple spaces
			if (lines[i].indexOf("r b ")>-1){//"r  b   avm   fre  ...
				key=lines[i].split(" ");
			}
			else if (typeof key !== 'undefined'){//the key is already created
				var values = lines[i].split(" ");
				if (!isNaN(parseFloat(values[0])) && isFinite(values[0])){
					var keyValue = [];
					for (var j = 0; j < values.length; j++) {
						keyValue[ key[j] ] = parseInt(values[j]);
					}	
					keyValuePairs.push(keyValue);
				}
			}
		}	
	return keyValuePairs;
	}

		
	var serviceProperties = {
		contentType: ["text/plain"],
	  	name: "Vmstat Columnizer",
	  	id: "orion.edit.vmstatColumnizer",
	  	key : [ "v", true ]
	};		
	
	provider.registerServiceProvider("orion.edit.command",serviceImpl, serviceProperties);
    provider.connect();	
};
</script>
</head>
<body>
</body>
</html>

/*
 *  contentType: ["application/javascript"],
 run : function(selectedText, text, selection) {
   return 
    {text: text.substring(0,selection.start) + "/*" + 
           text.substring(selection.start,selection.end) + "*/" + 
           text.substring(selection.end),
     selection: {start:selection.start,end:selection.end+4}};
 }

 */
